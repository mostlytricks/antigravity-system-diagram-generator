<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Draw.io Agent</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .card {
            background: var(--surface);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        h2 {
            margin-top: 0;
            font-size: 1.25rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        input,
        textarea,
        button {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }

        button:hover {
            opacity: 0.9;
        }

        pre {
            background: #1e1e1e;
            color: #e1e1e1;
            padding: 1rem;
            border-radius: 4px;
            overflow: auto;
            max-height: 400px;
            font-size: 0.85rem;
        }

        .status {
            font-size: 0.875rem;
            color: #64748b;
            margin-top: -0.5rem;
            margin-bottom: 1rem;
        }

        #d3-container {
            width: 100%;
            height: 400px;
            border: 1px solid #e2e8f0;
            background: #f1f5f9;
            /* Graph Paper color */
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
    </style>
</head>

<body>
    <h1 style="text-align:center; margin-bottom: 2rem;">Draw.io Generator Agent</h1>

    <div class="container">
        <!-- Panel 1: Extract/Learn -->
        <div class="card">
            <h2>1. Teach (Analyze & Visualize)</h2>
            <p style="font-size:0.9rem; color:#64748b;">Upload a .drawio file to visualize its structure here.</p>

            <input type="file" id="sampleFile" accept=".drawio,.xml">
            <button onclick="uploadSample()">Analyze & Visualize</button>
            <div id="extractStatus" class="status"></div>

            <label>Visualization Preview:</label>
            <div id="d3-container"></div>
        </div>

        <!-- Panel 2: Generate -->
        <div class="card">
            <h2>2. Build</h2>
            <label>What do you want to draw?</label>
            <textarea id="prompt" rows="4"
                placeholder="e.g., A microservices architecture with an API Gateway..."></textarea>
            <button onclick="generateGraph()">Generate Diagram</button>

            <label>Generated XML:</label>
            <pre id="xmlOutput">// XML result will appear here</pre>
            <button onclick="downloadXml()" style="background:#10b981; margin-top:10px;">Download .drawio</button>
        </div>
    </div>

    <script>
        let learnedContext = null;

        async function uploadSample() {
            const fileInput = document.getElementById('sampleFile');
            const status = document.getElementById('extractStatus');
            const container = document.getElementById('d3-container');

            if (!fileInput.files[0]) {
                alert("Please select a file");
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            status.textContent = "Analyzing...";
            container.innerHTML = ""; // Clear previous

            try {
                const res = await fetch('/api/extract', { method: 'POST', body: formData });
                const data = await res.json();

                if (data.success) {
                    learnedContext = data.data;
                    status.textContent = "Success! Found " + data.data.nodes.length + " nodes.";
                    renderGraph(data.data.nodes, data.data.edges);
                } else {
                    status.textContent = "Error: " + data.error;
                }
            } catch (e) {
                status.textContent = "Error: " + e.message;
            }
        }

        function renderGraph(nodes, edges) {
            const container = document.getElementById('d3-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            const svg = d3.select("#d3-container")
                .append("svg")
                .attr("width", "100%")
                .attr("height", "100%")
                .call(d3.zoom().on("zoom", (event) => {
                    g.attr("transform", event.transform);
                }))
                .append("g");

            const g = svg.append("g");

            // Helper to map ID to Node
            const nodeMap = new Map(nodes.map(n => [n.id, n]));

            // Draw Edges (handling orthogonal)
            const edgeGroup = g.append("g").attr("class", "edges");

            edgeGroup.selectAll(".edge-path")
                .data(edges)
                .join("path")
                .attr("class", "edge-path")
                .attr("fill", "none")
                .attr("stroke", "#64748b")
                .attr("stroke-width", 2)
                .attr("d", d => {
                    const src = nodeMap.get(d.source);
                    const tgt = nodeMap.get(d.target);
                    if (!src || !tgt) return "";

                    const sx = parseFloat(src.x) + parseFloat(src.width) / 2;
                    const sy = parseFloat(src.y) + parseFloat(src.height) / 2;
                    const tx = parseFloat(tgt.x) + parseFloat(tgt.width) / 2;
                    const ty = parseFloat(tgt.y) + parseFloat(tgt.height) / 2;

                    // Check for orthogonal style
                    if (d.style && d.style.includes("orthogonalEdgeStyle")) {
                        // Simple Manhattan routing: Mid-Y step
                        const midY = (sy + ty) / 2;
                        return `M ${sx},${sy} L ${sx},${midY} L ${tx},${midY} L ${tx},${ty}`;
                    } else {
                        // Direct line
                        return `M ${sx},${sy} L ${tx},${ty}`;
                    }
                });

            // Draw Nodes
            const nodeGroups = g.selectAll(".node")
                .data(nodes)
                .join("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${d.x}, ${d.y})`);

            nodeGroups.each(function (d) {
                const el = d3.select(this);
                const w = parseFloat(d.width || 80);
                const h = parseFloat(d.height || 40);

                // Check style for shape hint
                if (d.style && d.style.includes("ellipse")) {
                    el.append("ellipse")
                        .attr("cx", w / 2)
                        .attr("cy", h / 2)
                        .attr("rx", w / 2)
                        .attr("ry", h / 2)
                        .attr("fill", "#eff6ff")
                        .attr("stroke", "#3b82f6")
                        .attr("stroke-width", 2);
                } else if (d.style && d.style.includes("cylinder")) {
                    el.append("path")
                        .attr("d", `M0,${h * 0.2} v${h * 0.6} a${w / 2},${h * 0.2} 0 0,0 ${w},0 v-${h * 0.6} a${w / 2},${h * 0.2} 0 0,1 -${w},0 z`)
                        .attr("fill", "#fffbeb")
                        .attr("stroke", "#f59e0b")
                        .attr("stroke-width", 2);
                    el.append("ellipse")
                        .attr("cx", w / 2)
                        .attr("cy", h * 0.2)
                        .attr("rx", w / 2)
                        .attr("ry", h * 0.2)
                        .attr("fill", "#fffbeb")
                        .attr("stroke", "#f59e0b")
                        .attr("stroke-width", 2);
                } else {
                    // Default Rect
                    el.append("rect")
                        .attr("width", w)
                        .attr("height", h)
                        .attr("fill", "white")
                        .attr("stroke", "#334155")
                        .attr("stroke-width", 2)
                        .attr("rx", 4);
                }

                // Label
                el.append("text")
                    .attr("x", w / 2)
                    .attr("y", h / 2)
                    .attr("dy", "0.35em")
                    .attr("text-anchor", "middle")
                    .style("font-size", "12px")
                    .style("font-family", "sans-serif")
                    .style("pointer-events", "none")
                    .text(d.value);
            });
        }

        async function generateGraph() {
            const prompt = document.getElementById('prompt').value;
            const output = document.getElementById('xmlOutput');

            if (!prompt) {
                alert("Please enter a prompt");
                return;
            }

            output.textContent = "Generating... (this may take a few seconds)";
            try {
                const res = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, context: learnedContext })
                });
                const data = await res.json();

                if (data.success) {
                    output.textContent = data.xml;
                } else {
                    output.textContent = "Error: " + data.error;
                }
            } catch (e) {
                output.textContent = "Error: " + e.message;
            }
        }

        function downloadXml() {
            const xml = document.getElementById('xmlOutput').textContent;
            if (!xml || xml.startsWith("//")) return;

            const blob = new Blob([xml], { type: 'text/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'generated_diagram.drawio';
            a.click();
        }
    </script>
</body>

</html>