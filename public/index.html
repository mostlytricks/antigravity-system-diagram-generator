<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Draw.io Viewer â€” Notion Style</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --bg: #191919;
            --surface: #202020;
            --border: #2E2E2E;
            --text-primary: rgba(255, 255, 255, 0.9);
            --text-secondary: rgba(255, 255, 255, 0.5);
            --accent: #2eaadc;
            --hover: #2b2b2b;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            background: var(--bg);
            color: var(--text-primary);
            line-height: 1.5;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        header {
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg);
            z-index: 10;
        }

        .title {
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .title-icon {
            width: 18px;
            height: 18px;
            filter: invert(1);
        }

        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        input[type="file"] {
            display: none;
        }

        .btn-custom {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s;
            font-weight: 400;
        }

        .btn-custom:hover {
            background: var(--hover);
        }

        .main-content {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            padding: 2rem;
            align-items: center;
        }

        #viewer-card {
            width: 100%;
            height: 100%;
            max-width: 1400px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        #d3-container {
            flex: 1;
            width: 100%;
            background: #1e1e1e;
            /* Subtle grid logic */
            background-image: radial-gradient(circle, #2e2e2e 1px, transparent 1px);
            background-size: 30px 30px;
        }

        .status-bar {
            padding: 8px 16px;
            border-top: 1px solid var(--border);
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            background: var(--surface);
        }

        /* SVG Styles */
        .edge-path {
            stroke: #4a4a4a;
            stroke-width: 1.5;
            fill: none;
            transition: stroke 0.2s;
        }
        .edge-path:hover {
            stroke: var(--accent);
        }

        .node rect, .node ellipse, .node path {
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .node text {
            fill: rgba(255, 255, 255, 0.85);
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
    </style>
</head>

<body>
    <header>
        <div class="title">
            <svg viewBox="0 0 24 24" class="title-icon"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M13,9V3.5L18.5,9H13Z" /></svg>
            <span>Draw.io Architectural Viewer</span>
        </div>
        <div class="controls">
            <label for="sampleFile" class="btn-custom">Choose .drawio file</label>
            <input type="file" id="sampleFile" accept=".drawio,.xml" onchange="uploadSample()">
            <span id="fileName" style="font-size: 12px; color: var(--text-secondary);">No file chosen</span>
        </div>
    </header>

    <div class="main-content">
        <div id="viewer-card">
            <div id="d3-container"></div>
            <div class="status-bar">
                <span id="extractStatus">Ready for visualization</span>
                <span id="stats">0 nodes, 0 edges</span>
            </div>
        </div>
    </div>

    <script>
        async function uploadSample() {
            const fileInput = document.getElementById('sampleFile');
            const status = document.getElementById('extractStatus');
            const stats = document.getElementById('stats');
            const fileNameDisp = document.getElementById('fileName');
            const container = document.getElementById('d3-container');

            if (!fileInput.files[0]) return;
            
            const file = fileInput.files[0];
            fileNameDisp.textContent = file.name;

            const formData = new FormData();
            formData.append('file', file);

            status.textContent = "Analyzing structure...";
            container.innerHTML = ""; 

            try {
                const res = await fetch('/api/extract', { method: 'POST', body: formData });
                const data = await res.json();

                if (data.success) {
                    status.textContent = "Successfully rendered diagram.";
                    stats.textContent = `${data.data.nodes.length} nodes, ${data.data.edges.length} edges`;
                    renderGraph(data.data.nodes, data.data.edges);
                } else {
                    status.textContent = "Error: " + data.error;
                }
            } catch (e) {
                status.textContent = "Error: " + e.message;
            }
        }

        function renderGraph(nodes, edges) {
            const container = document.getElementById('d3-container');
            
            const svg = d3.select("#d3-container")
                .append("svg")
                .attr("width", "100%")
                .attr("height", "100%")
                .attr("viewBox", `0 0 ${container.clientWidth} ${container.clientHeight}`)
                .call(d3.zoom().scaleExtent([0.1, 4]).on("zoom", (event) => {
                    g.attr("transform", event.transform);
                }));

            const g = svg.append("g");

            const nodeMap = new Map(nodes.map(n => [n.id, n]));

            // Draw Edges
            const edgeGroup = g.append("g").attr("class", "edges");
            edgeGroup.selectAll(".edge-path")
                .data(edges)
                .join("path")
                .attr("class", "edge-path")
                .attr("d", d => {
                    const src = nodeMap.get(d.source);
                    const tgt = nodeMap.get(d.target);
                    if (!src || !tgt) return "";

                    const sx = parseFloat(src.x) + parseFloat(src.width) / 2;
                    const sy = parseFloat(src.y) + parseFloat(src.height) / 2;
                    const tx = parseFloat(tgt.x) + parseFloat(tgt.width) / 2;
                    const ty = parseFloat(tgt.y) + parseFloat(tgt.height) / 2;

                    if (d.style && d.style.includes("orthogonalEdgeStyle")) {
                        const midY = (sy + ty) / 2;
                        return `M ${sx},${sy} L ${sx},${midY} L ${tx},${midY} L ${tx},${ty}`;
                    }
                    return `M ${sx},${sy} L ${tx},${ty}`;
                });

            // Draw Nodes
            const nodeGroups = g.selectAll(".node")
                .data(nodes)
                .join("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${d.x}, ${d.y})`);

            nodeGroups.each(function (d) {
                const el = d3.select(this);
                const w = parseFloat(d.width || 80);
                const h = parseFloat(d.height || 40);

                // Notion-inspired colors (subtle dark fills)
                let fill = "#2C2C2C";
                let stroke = "#404040";

                if (d.style && d.style.includes("fillColor")) {
                   // Optional: map drawio colors to dark mode version or keep as is with lower opacity
                }

                if (d.style && d.style.includes("ellipse")) {
                    el.append("ellipse")
                        .attr("cx", w / 2).attr("cy", h / 2)
                        .attr("rx", w / 2).attr("ry", h / 2)
                        .attr("fill", fill).attr("stroke", stroke).attr("stroke-width", 1.5);
                } else if (d.style && d.style.includes("cylinder")) {
                    el.append("path")
                        .attr("d", `M0,${h * 0.2} v${h * 0.6} a${w / 2},${h * 0.2} 0 0,0 ${w},0 v-${h * 0.6} a${w / 2},${h * 0.2} 0 0,1 -${w},0 z`)
                        .attr("fill", fill).attr("stroke", stroke).attr("stroke-width", 1.5);
                    el.append("ellipse")
                        .attr("cx", w / 2).attr("cy", h * 0.2)
                        .attr("rx", w / 2).attr("ry", h * 0.2)
                        .attr("fill", fill).attr("stroke", stroke).attr("stroke-width", 1.5);
                } else {
                    el.append("rect")
                        .attr("width", w).attr("height", h)
                        .attr("fill", fill).attr("stroke", stroke).attr("stroke-width", 1.5)
                        .attr("rx", 3);
                }

                el.append("text")
                    .attr("x", w / 2).attr("y", h / 2)
                    .attr("dy", "0.35em")
                    .attr("text-anchor", "middle")
                    .style("font-size", "11px")
                    .style("pointer-events", "none")
                    .text(d.value);
            });

            // Auto-zoom to fit content
            const bbox = g.node().getBBox();
            if (bbox.width > 0 && bbox.height > 0) {
                const fullWidth = container.clientWidth;
                const fullHeight = container.clientHeight;
                const midX = bbox.x + bbox.width / 2;
                const midY = bbox.y + bbox.height / 2;
                
                const scale = Math.min(0.9, 0.9 / Math.max(bbox.width / fullWidth, bbox.height / fullHeight));
                const transform = d3.zoomIdentity
                    .translate(fullWidth / 2, fullHeight / 2)
                    .scale(scale)
                    .translate(-midX, -midY);

                svg.transition().duration(750).call(d3.zoom().transform, transform);
            }
        }
    </script>
</body>

</html>
